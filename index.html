<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>평범한 일상 속 비주류가 되는 경험</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@100..900&display=swap" rel="stylesheet">
    <style>
        .noto-sans-kr-<uniquifier> {
            font-family: "Noto Sans KR", sans-serif;
            font-optical-sizing: auto;
            font-weight: <weight>;
            font-style: normal;
        }

        * {
            word-break: keep-all;
        }

        body {
            background-color: #000;
            color: #eee;
            font-family: "Noto Sans KR", sans-serif;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            overflow: hidden;
            cursor: none;
            padding-top: 0;
            transition: background-color 0.3s ease;
        }

        #content-wrapper {
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            align-items: center;
        }

        .page-title {
            font-size: 45px;
            font-weight: 400;
            color: #FFFF00;
            margin-bottom: 20px;
            min-height: 0;
            position: relative;
            text-align: center;
            width: 90vw;
        }

        .page-title.typing-cursor::after {
            content: '|';
            display: inline-block;
            animation: blink 1s infinite;
            color: #FFFF00;
            font-weight: 700;
            margin-left: 2px;
        }

        @keyframes blink {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0;
            }
        }

        @keyframes arrow-breathe {

            0%,
            100% {
                transform: translateY(-50%) rotate(45deg) scale(1.0);
            }

            50% {
                transform: translateY(-50%) rotate(45deg) scale(1.3);
            }
        }

        .main-container {
            display: flex;
            justify-content: center;
            align-items: flex-start;
            gap: 30px;
            padding: 0px;

            transform: scale(0.666);
        }

        .keyboard-container {
            display: flex;
            flex-direction: column;
            gap: 8px;
            padding: 20px;
            border: 1.5px solid #fff;
            border-radius: 10px;
            transition: border-color 0.3s ease;
        }

        .keyboard-row {
            display: flex;
            gap: 8px;
            justify-content: center;
            align-items: flex-end;
        }

        .key {
            width: 40px;
            height: 40px;
            border: 1.5px solid #fff;
            border-radius: 5px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 14px;
            font-weight: 500;
            box-sizing: border-box;
            transition: opacity 0.3s ease, background-color 0.1s, color 0.1s;
        }

        .key.active {
            background-color: #fff;
            color: #000;
            border-color: #fff;
        }

        .trackpad-container {
            width: 280px;
            height: 220px;
            border: 1.5px solid #fff;
            border-radius: 10px;
            margin-top: 0px;
            position: relative;
            overflow: hidden;
            transition: opacity 0.3s ease, border-color 0.3s ease;
        }

        .trackpad-cursor {
            width: 20px;
            height: 20px;
            background-color: #fff;
            border-radius: 50%;
            position: absolute;
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
            transition: opacity 1s ease, visibility 1s ease;
        }

        .trackpad-cursor.visible {
            opacity: 1;
            visibility: visible;
        }

        .arrow-key-cluster {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .arrow-key-row {
            display: flex;
            justify-content: center;
            gap: 8px;
        }

        .key.empty {
            border: none;
            visibility: hidden;
        }

        #left-arrow-key {
            transform: rotate(180deg);
        }

        .nav-arrow {
            position: absolute;
            top: 50%;
            width: 25px;
            height: 25px;

            border: 5px solid #FFFF00;
            border-bottom: 0;
            border-left: 0;

            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease, filter 0.2s ease, transform 0.1s ease-out;
        }

        #nav-arrow-right {
            right: 60px;
            transform: translateY(-50%) rotate(45deg) scale(1.0);
        }



        .nav-arrow.visible {
            opacity: 1;
            animation: arrow-breathe 1.5s infinite ease-in-out;
        }

        #nav-arrow-right.active {
            animation: none;
            opacity: 1;
            filter: drop-shadow(0 0 10px #FFFF00) brightness(1.5);
            transform: translateY(-50%) rotate(45deg) scale(0.85);
        }



        #experience-container {
            text-align: center;
            opacity: 0;
            transition: opacity 0.5s ease 0.2s;
            pointer-events: none;
            margin-top: -30px;
        }

        #experience-container.visible {
            opacity: 1;
            pointer-events: auto;
        }

        #experience-button {
            display: inline-block;
            border: 2px solid #FFFF00;
            color: #FFFF00;
            background: transparent;
            padding: 8px 18px;
            border-radius: 4px;
            font-size: 18px;
            font-weight: 500;
        }

        #space-hint {
            color: #FFFF00;
            font-size: 14px;
            margin-top: 4px;
            font-weight: 300;
        }

        body.ghost-mode .keyboard-container {
            border-color: transparent;
        }

        body.ghost-mode .trackpad-container {
            border-color: transparent;
        }

        body.ghost-mode .key {
            opacity: 0;
        }

        body.ghost-mode .key.active {
            opacity: 1;
        }

        .global-nav {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 1000;
            color: rgba(255, 255, 255, 0.5);
            font-size: 14px;
            display: flex;
            gap: 15px;
            pointer-events: none;
            font-family: "Noto Sans KR", sans-serif;
        }

        #voice-hint {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            color: rgba(255, 255, 255, 0.5);
            font-size: 14px;
            font-family: "Noto Sans KR", sans-serif;
            opacity: 0;
            transition: opacity 0.5s ease;
            pointer-events: none;
            z-index: 1000;
        }

        #voice-hint.visible {
            opacity: 1;
        }
    </style>
</head>

<body>

    <div class="global-nav">
        <span>[1] 시각장애인</span>
        <span>[2] 청각장애인</span>
        <span>[3] 지체장애인 + 적록색약</span>
    </div>

    <div id="content-wrapper">

        <h1 class="page-title" id="pageTitle"></h1>

        <div class="main-container">
            <div class="keyboard-container">

                <div class="keyboard-row">
                    <div class="key" data-code="Escape">ESC</div>
                    <div class="key" data-code="F1">F1</div>
                    <div class="key" data-code="F2">F2</div>
                    <div class="key" data-code="F3">F3</div>
                    <div class="key" data-code="F4">F4</div>
                    <div class="key" data-code="F5">F5</div>
                    <div class="key" data-code="F6">F6</div>
                    <div class="key" data-code="F7">F7</div>
                    <div class="key" data-code="F8">F8</div>
                    <div class="key" data-code="F9">F9</div>
                    <div class="key" data-code="F10">F10</div>
                    <div class="key" data-code="F11">F11</div>
                    <div class="key" data-code="F12">F12</div>
                    <div class="key" data-code="Power">⏻</div>
                </div>

                <div class="keyboard-row">
                    <div class="key" data-code="Backquote">` ~</div>
                    <div class="key" data-code="Digit1">1 !</div>
                    <div class="key" data-code="Digit2">2 @</div>
                    <div class="key" data-code="Digit3">3 #</div>
                    <div class="key" data-code="Digit4">4 $</div>
                    <div class="key" data-code="Digit5">5 %</div>
                    <div class="key" data-code="Digit6">6 ^</div>
                    <div class="key" data-code="Digit7">7 &</div>
                    <div class="key" data-code="Digit8">8 *</div>
                    <div class="key" data-code="Digit9">9 (</div>
                    <div class="key" data-code="Digit0">0 )</div>
                    <div class="key" data-code="Minus">- _</div>
                    <div class="key" data-code="Equal">= +</div>
                    <div class="key" data-code="Backspace" style="width: 88px;">DELETE</div>
                </div>

                <div class="keyboard-row">
                    <div class="key" data-code="Tab" style="width: 88px;">TAB</div>
                    <div class="key" data-code="KeyQ">Q</div>
                    <div class="key" data-code="KeyW">W</div>
                    <div class="key" data-code="KeyE">E</div>
                    <div class="key" data-code="KeyR">R</div>
                    <div class="key" data-code="KeyT">T</div>
                    <div class="key" data-code="KeyY">Y</div>
                    <div class="key" data-code="KeyU">U</div>
                    <div class="key" data-code="KeyI">I</div>
                    <div class="key" data-code="KeyO">O</div>
                    <div class="key" data-code="KeyP">P</div>
                    <div class="key" data-code="BracketLeft">[ {</div>
                    <div class="key" data-code="BracketRight">] }</div>
                    <div class="key" data-code="Backslash">\ |</div>
                </div>

                <div class="keyboard-row">
                    <div class="key" data-code="CapsLock" style="width: 108px;">CAPS</div>
                    <div class="key" data-code="KeyA">A</div>
                    <div class="key" data-code="KeyS">S</div>
                    <div class="key" data-code="KeyD">D</div>
                    <div class="key" data-code="KeyF">F</div>
                    <div class="key" data-code="KeyG">G</div>
                    <div class="key" data-code="KeyH">H</div>
                    <div class="key" data-code="KeyJ">J</div>
                    <div class="key" data-code="KeyK">K</div>
                    <div class="key" data-code="KeyL">L</div>
                    <div class="key" data-code="Semicolon">; :</div>
                    <div class="key" data-code="Quote">' "</div>
                    <div class="key" data-code="Enter" style="width: 88px;">ENTER</div>
                </div>

                <div class="keyboard-row">
                    <div class="key" data-code="ShiftLeft" style="width: 138px;">SHIFT</div>
                    <div class="key" data-code="KeyZ">Z</div>
                    <div class="key" data-code="KeyX">X</div>
                    <div class="key" data-code="KeyC">C</div>
                    <div class="key" data-code="KeyV">V</div>
                    <div class="key" data-code="KeyB">B</div>
                    <div class="key" data-code="KeyN">N</div>
                    <div class="key" data-code="KeyM">M</div>
                    <div class="key" data-code="Comma">, &lt;</div>
                    <div class="key" data-code="Period">. &gt;</div>
                    <div class="key" data-code="Slash">/ ?</div>
                    <div class="key" data-code="ShiftRight" style="width: 108px;">SHIFT</div>
                </div>

                <div class="keyboard-row">
                    <div class="key" data-code="Fn">fn</div>
                    <div class="key" data-code="ControlLeft">ctrl</div>
                    <div class="key" data-code="AltLeft">opt</div>
                    <div class="key" data-code="MetaLeft" style="width: 50px;">cmd</div>
                    <div class="key" data-code="Space" style="width: 236px;"></div>
                    <div class="key" data-code="MetaRight" style="width: 50px;">cmd</div>
                    <div class="key" data-code="AltRight">opt</div>
                    <div class="key" data-code="Lang1">한/영</div>

                    <div class="arrow-key-cluster">
                        <div class="arrow-key-row">
                            <div class="key empty" style="width: 40px;"></div>
                            <div class="key" data-code="ArrowUp">▲</div>
                            <div class="key empty" style="width: 40px;"></div>
                        </div>
                        <div class="arrow-key-row">
                            <div class="key" data-code="ArrowLeft" id="left-arrow-key">►</div>
                            <div class="key" data-code="ArrowDown">▼</div>
                            <div class="key" data-code="ArrowRight">►</div>
                        </div>
                    </div>
                </div>

            </div>

            <div class="trackpad-container" id="trackpad">
                <div class="trackpad-cursor" id="cursor"></div>
            </div>
        </div>

        <div id="experience-container">
            <div id="experience-button">경험하기</div>
            <p id="space-hint">space</p>
        </div>

    </div>


    <div class="nav-arrow" id="nav-arrow-right"></div>
    <div id="voice-hint">마이크가 활성화 되면 키보드 그래픽이 우측에서 좌측으로 빛이 납니다.</div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {

            let typingStarted = false;
            let isTyping = false;
            let currentPage = 1;
            const storyPages = [
                "특정 사람들에게만 편한 세상",
                "비장애인이 차별받는 세상에 살아본다면?",
                "비장애인이 도서관을 찾아가<br>책을 빌리는 평범한 과정 속에서도...",
                "장애인이 된다면 얼마나 많은 어려움이 있겠는가?",
                ""
            ];

            const titleElement = document.getElementById('pageTitle');

            const navArrowRight = document.getElementById('nav-arrow-right');
            const experienceContainer = document.getElementById('experience-container');
            const voiceHint = document.getElementById('voice-hint');

            const bgm = new Audio('ravel.mp3');
            bgm.loop = true;
            let page1TypingComplete = false;

            // Resume background music if it was playing
            const bgmPlaying = sessionStorage.getItem('bgmPlaying');
            const bgmTime = sessionStorage.getItem('bgmTime');

            if (bgmPlaying === 'true' && bgmTime) {
                bgm.currentTime = parseFloat(bgmTime);
                bgm.play().catch(e => console.log("Audio resume failed:", e));
            }

            // Typing sounds
            let currentKeySound = 1;
            const key1 = new Audio('key_1.wav');
            const key2 = new Audio('key_2.wav');

            function playTypingSound() {
                const soundToPlay = currentKeySound === 1 ? key1 : key2;
                soundToPlay.cloneNode().play().catch(e => console.log("Audio play failed:", e));
                currentKeySound = currentKeySound === 1 ? 2 : 1;
            }

            let sortedKeyboardColumns = [];

            function calculateKeyboardColumns() {
                const keys = Array.from(document.querySelectorAll('.key'));
                const columns = {};

                // Group keys by their visual column (approximate X position)
                keys.forEach(key => {
                    const rect = key.getBoundingClientRect();
                    const x = Math.round(rect.left / 10) * 10; // Group by 10px buckets
                    if (!columns[x]) {
                        columns[x] = [];
                    }
                    columns[x].push(key);
                });

                // Sort columns from right to left and store globally
                const sortedX = Object.keys(columns).sort((a, b) => b - a);
                sortedKeyboardColumns = sortedX.map(x => columns[x]);
            }

            window.addEventListener('resize', calculateKeyboardColumns);
            // Calculate initially
            setTimeout(calculateKeyboardColumns, 100);

            titleElement.classList.add('typing-cursor');

            let typeTimeout;
            function startTypewriter(text, onCompleteCallback) {
                clearTimeout(typeTimeout);
                titleElement.innerHTML = '';
                if (text) {
                    titleElement.classList.add('typing-cursor');
                }
                isTyping = true;
                let index = 0;

                function typeChar() {
                    if (text && index < text.length) {
                        if (text.substring(index, index + 4) === '<br>') {
                            titleElement.innerHTML += '<br>';
                            index += 4;
                        } else {
                            titleElement.innerHTML += text.charAt(index);
                            index++;
                        }
                        typeTimeout = setTimeout(typeChar, 120);
                    } else {
                        titleElement.classList.remove('typing-cursor');
                        isTyping = false;
                        if (onCompleteCallback) {
                            onCompleteCallback();
                        }
                    }
                }
                typeChar();
            }

            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            let recognition;
            let isVUIActive = false;
            let currentVUIState = 'main';
            let isSpeaking = false;
            let lastSpokenPrompt = "";

            if (SpeechRecognition) {
                recognition = new SpeechRecognition();
                recognition.lang = 'ko-KR';
                recognition.interimResults = true;
                recognition.continuous = true;

                recognition.onresult = handleVoiceResult;

                recognition.onend = () => {
                    if (isVUIActive && !isSpeaking) {
                        try {
                            recognition.start();
                        } catch (e) {
                            console.error("Recognition restart error in onend:", e);
                        }
                    }
                };

                recognition.onerror = (event) => {
                    if (event.error === 'not-allowed' || event.error === 'service-not-allowed') {
                        stopVUI();
                        alert("마이크 권한이 차단되었습니다. 페이지를 새로고침하고 권한을 허용해주세요.");
                    } else if (event.error !== 'aborted') {
                        console.error('Speech recognition error', event.error);
                    }
                };
            }

            function speak(text, onEndCallback = null) {
                if (!isVUIActive && currentPage !== 5) return;

                isSpeaking = true;
                if (recognition) {
                    recognition.stop();
                }
                speechSynthesis.cancel();

                lastSpokenPrompt = text;
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'ko-KR';
                utterance.rate = 1.0;

                utterance.onend = () => {
                    isSpeaking = false;
                    if (onEndCallback) {
                        onEndCallback();
                    }
                    if (isVUIActive) {
                        try {
                            recognition.start();
                        } catch (e) {
                            console.error("Recognition start error after speak:", e);
                        }
                    }
                };

                utterance.onerror = () => {
                    isSpeaking = false;
                    if (isVUIActive) {
                        try {
                            recognition.start();
                        } catch (e) { }
                    }
                };

                speechSynthesis.speak(utterance);
            }

            let isWaveAnimating = false;

            function handleVoiceResult(event) {
                if (isSpeaking) return;

                let transcript = "";
                let isFinal = false;

                for (let i = event.resultIndex; i < event.results.length; ++i) {
                    if (event.results[i].isFinal) {
                        transcript += event.results[i][0].transcript;
                        isFinal = true;
                    } else {
                        // Interim result
                        if (!isWaveAnimating) {
                            triggerKeyboardWave();
                        }
                    }
                }

                if (!isFinal) return;

                transcript = transcript.trim().replace(/\s+/g, '');

                if (transcript === "") return;

                // Trigger wave again on final result if needed, or just ensure it ran
                if (!isWaveAnimating) {
                    triggerKeyboardWave();
                }

                if (currentVUIState === 'main') {
                    if (transcript.includes('하나') || transcript === '1') {
                        currentVUIState = 'map';
                        const mapPrompt = "이어서 진행합니다. 장소를 검색하시려면 '하나', 지도 앱을 나가시려면 '둘', 다시 들으시려면 '셋'이라고 말씀하세요.";
                        speak(mapPrompt);
                    } else if (transcript.includes('둘') || transcript === '2') {
                        goToPage(1);
                    } else if (transcript.includes('셋') || transcript === '3') {
                        const initialPrompt = "음성 인터페이스가 활성화되었습니다. 지도 앱을 찾으시려면 '하나', 포기하시려면 '둘', 다시 들으시려면 '셋'이라고 말씀하세요.";
                        speak(initialPrompt);
                    }
                } else if (currentVUIState === 'map') {
                    if (transcript.includes('하나') || transcript === '1') {
                        currentVUIState = 'map_search';
                        const searchPrompt = "검색합니다. 찾으실 목적지를 말씀해주세요.";
                        speak(searchPrompt);
                    } else if (transcript.includes('둘') || transcript === '2') {
                        currentVUIState = 'main';
                        const initialPrompt = "지도 앱을 종료합니다. 지도 앱을 찾으시려면 '하나', 포기하시려면 '둘', 다시 들으시려면 '셋'이라고 말씀하세요.";
                        speak(initialPrompt);
                    } else if (transcript.includes('셋') || transcript === '3') {
                        const mapPrompt = "장소를 검색하시려면 '하나', 지도 앱을 나가시려면 '둘', 다시 들으시려면 '셋'이라고 말씀하세요.";
                        speak(mapPrompt);
                    }
                } else if (currentVUIState === 'map_search') {
                    const destination = transcript.replace(/ /g, '');
                    currentVUIState = 'map_results';
                    const response1 = `'${destination}'을 검색합니다. 주변에서 3개의 결과를 찾았습니다.`;
                    const response2 = "하나, '서울중앙도서관', 현재 위치에서 300미터. 둘, '늘푸른도서관', 1.2킬로미터. 셋, '어린이 평화 도서관', 2.1킬로미터. 원하시는 장소의 번호를 말씀해주세요.";
                    speak(response1, () => {
                        speak(response2);
                    });
                } else if (currentVUIState === 'map_results') {
                    if (transcript.includes('하나') || transcript === '1' || transcript.includes('둘') || transcript === '2' || transcript.includes('셋') || transcript === '3') {
                        currentVUIState = 'map_confirm_route';
                        const confirmPrompt = "말씀하신 장소를 목적지로 선택합니다. 경로 안내를 시작하시겠습니까? '안내 시작' 또는 '취소'라고 말씀해주세요.";
                        speak(confirmPrompt);
                    }
                } else if (currentVUIState === 'map_confirm_route') {
                    if (transcript.includes('안내시작')) {
                        currentVUIState = 'main';
                        const farewellPrompt = "경로 안내를 시작합니다. 지금까지 시각장애인이 주류가 되는 사회 시뮬레이션이었습니다. 다음 시뮬레이션 페이지로 이동합니다.";
                        speak(farewellPrompt, () => {
                            window.location.href = 'ear.html';
                        });
                    } else if (transcript.includes('취소')) {
                        currentVUIState = 'main';
                        speak("경로 안내를 취소합니다. 지도 앱 초기 메뉴로 돌아갑니다.", () => {
                            const initialPrompt = "지도 앱을 찾으시려면 '하나', 포기하시려면 '둘', 다시 들으시려면 '셋'이라고 말씀하세요.";
                            speak(initialPrompt);
                        });
                    }
                }
            }

            function startVUI() {
                bgm.pause();
                sessionStorage.setItem('bgmTime', bgm.currentTime);
                sessionStorage.setItem('bgmPlaying', 'true');

                if (!recognition) {
                    alert("이 브라우저에서는 음성 인식을 지원하지 않습니다.");
                    return;
                }

                isVUIActive = true;
                currentVUIState = 'main';

                const initialPrompt = "음성 인터페이스가 활성화되었습니다. 지도 앱을 찾으시려면 '하나', 포기하시려면 '둘', 다시 들으시려면 '셋'이라고 말씀하세요.";

                speak(initialPrompt);
            }

            function stopVUI() {
                isVUIActive = false;
                if (recognition) {
                    recognition.stop();
                }
                speechSynthesis.cancel();
            }

            function requestMicPermission() {
                if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                    alert("이 브라우저에서는 마이크 접근을 지원하지 않습니다.");
                    return;
                }
                navigator.mediaDevices.getUserMedia({ audio: true })
                    .then((stream) => {
                        stream.getTracks().forEach(track => track.stop());
                        goToPage(5);
                    })
                    .catch((err) => {
                        console.error("Mic permission denied:", err);
                        alert("음성 인터페이스를 사용하려면 마이크 권한이 필요합니다. 페이지를 새로고침하고 권한을 허용해주세요.");
                    });
            }

            function goToPage(pageNumber) {
                if (pageNumber === 5 && isTyping) {

                } else if (isTyping || pageNumber < 1 || pageNumber > storyPages.length) {
                    return;
                }

                currentPage = pageNumber;
                const newText = storyPages[currentPage - 1];

                if (currentPage === 5) {
                    document.body.classList.add('ghost-mode');
                    startVUI();
                } else {
                    document.body.classList.remove('ghost-mode');
                    stopVUI();
                }

                startTypewriter(newText, () => {
                    if (currentPage === 1) {
                        page1TypingComplete = true;
                    }
                    updateArrowVisibility();
                });
            }

            function updateArrowVisibility() {
                if (currentPage === 1) {

                    navArrowRight.classList.add('visible');
                }
                else if (currentPage > 1 && currentPage < 4) {

                    navArrowRight.classList.add('visible');
                }
                else if (currentPage === 4) {

                    navArrowRight.classList.add('visible');
                }
                else if (currentPage === storyPages.length) {

                    navArrowRight.classList.remove('visible');
                }

                if (currentPage === 4) {
                    experienceContainer.classList.add('visible');
                } else {
                    experienceContainer.classList.remove('visible');
                }

                if (currentPage === 5) {
                    voiceHint.classList.add('visible');
                } else {
                    voiceHint.classList.remove('visible');
                }
            }

            function animateKeyPress(keyCode, arrowElement = null) {
                const keyElement = document.querySelector(`.key[data-code="${keyCode}"]`);

                if (keyElement) keyElement.classList.add('active');
                if (arrowElement) arrowElement.classList.add('active');

                setTimeout(() => {
                    if (keyElement) keyElement.classList.remove('active');
                    if (arrowElement) arrowElement.classList.remove('active');
                }, 200);
            }

            function triggerKeyboardWave() {
                if (isWaveAnimating) return;
                isWaveAnimating = true;

                if (sortedKeyboardColumns.length === 0) {
                    calculateKeyboardColumns();
                }

                sortedKeyboardColumns.forEach((column, index) => {
                    setTimeout(() => {
                        column.forEach(key => {
                            key.classList.add('active');
                            setTimeout(() => {
                                key.classList.remove('active');
                            }, 150);
                        });

                        // Reset flag after the last column finishes
                        if (index === sortedKeyboardColumns.length - 1) {
                            setTimeout(() => {
                                isWaveAnimating = false;
                            }, 150);
                        }
                    }, index * 15); // Faster wave: 15ms delay
                });
            }

            typingStarted = true;
            goToPage(1);

            window.addEventListener('keydown', (e) => {
                e.preventDefault();

                if (currentPage !== 5) {
                    playTypingSound();
                }

                if (currentPage === 5) {
                    if (e.code === 'Escape') {
                        animateKeyPress(e.code);
                        goToPage(1);
                        return;
                    }

                    const keyElement = document.querySelector(`.key[data-code="${e.code}"]`);
                    if (keyElement && !keyElement.classList.contains('active')) {
                        keyElement.classList.add('active');
                        setTimeout(() => {
                            keyElement.classList.remove('active');
                        }, 500);
                    }

                    if (currentVUIState === 'main') {
                        speak("명령어를 말씀해주세요. '하나'는 지도 앱, '둘'은 포기입니다.");
                    } else {
                        if (lastSpokenPrompt) {
                            speak(lastSpokenPrompt);
                        } else {
                            speak("명령어를 말씀해주세요.");
                        }
                    }
                    return;
                }

                if (e.code === 'ArrowRight') {
                    animateKeyPress(e.code, navArrowRight);
                } else if (e.code === 'ArrowLeft') {
                    animateKeyPress(e.code);
                } else if (e.code === 'Space') {
                    animateKeyPress(e.code);
                } else if (e.code === 'Escape') {
                    animateKeyPress(e.code);
                } else {
                    const keyElement = document.querySelector(`.key[data-code="${e.code}"]`);
                    if (keyElement && !keyElement.classList.contains('active')) {
                        keyElement.classList.add('active');
                        setTimeout(() => {
                            keyElement.classList.remove('active');
                        }, 500);
                    }
                }

                if (isTyping) {
                    return;
                }

                if (e.code === 'Space') {
                    if (currentPage === 4) {
                        requestMicPermission();
                    }
                    return;
                }

                if (e.code === 'Escape') {
                    if (currentPage === 5) {
                        goToPage(1);
                    }
                    return;
                }

                if (e.code === 'ArrowRight') {
                    if (currentPage === 1) {
                        if (page1TypingComplete) {
                            bgm.play().catch(e => console.log("Audio play failed:", e));
                            setTimeout(() => goToPage(currentPage + 1), 100);
                        }
                    } else if (currentPage < storyPages.length && currentPage !== 4) {
                        setTimeout(() => goToPage(currentPage + 1), 100);
                    }
                    return;
                }

                if (e.code === 'ArrowLeft') {
                    // Left arrow navigation disabled
                    return;
                }

                if (e.key === '1' || e.key === '2' || e.key === '3') {
                    bgm.pause();
                    sessionStorage.setItem('bgmTime', bgm.currentTime);
                    sessionStorage.setItem('bgmPlaying', 'true');
                }

                if (e.key === '1') window.location.href = 'index.html';
                if (e.key === '2') window.location.href = 'ear.html';
                if (e.key === '3') window.location.href = 'color.html';
            });

            const trackpad = document.getElementById('trackpad');
            const cursor = document.getElementById('cursor');
            const cursorSize = 20;

            const trackpadWidth = trackpad.clientWidth;
            const trackpadHeight = trackpad.clientHeight;

            let cursorX = (trackpadWidth - cursorSize) / 2;
            let cursorY = (trackpadHeight - cursorSize) / 2;
            cursor.style.transform = `translate(${cursorX}px, ${cursorY}px)`;

            let lastMouseX = null;
            let lastMouseY = null;
            let movementTimer = null;

            document.addEventListener('mousemove', (e) => {
                if (lastMouseX === null) {
                    lastMouseX = e.clientX;
                    lastMouseY = e.clientY;
                    return;
                }

                if (movementTimer) {
                    clearTimeout(movementTimer);
                }

                cursor.classList.add('visible');

                const deltaX = e.clientX - lastMouseX;
                const deltaY = e.clientY - lastMouseY;

                cursorX += deltaX;
                cursorY += deltaY;

                const maxX = trackpadWidth - cursorSize;
                const maxY = trackpadHeight - cursorSize;

                cursorX = Math.max(0, Math.min(maxX, cursorX));
                cursorY = Math.max(0, Math.min(maxY, cursorY));

                cursor.style.transform = `translate(${cursorX}px, ${cursorY}px)`;

                lastMouseX = e.clientX;
                lastMouseY = e.clientY;

                movementTimer = setTimeout(() => {
                    cursor.classList.remove('visible');

                    lastMouseX = null;
                    lastMouseY = null;
                }, 500);
            });
        });
    </script>
</body>

</html>