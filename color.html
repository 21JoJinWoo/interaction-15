<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>지체장애, 각이상 경험</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@100..900&display=swap" rel="stylesheet">
    <style>
        * {
            word-break: keep-all;
        }

        body {
            background-color: #000;
            color: #eee;
            font-family: "Noto Sans KR", sans-serif;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            overflow: hidden;
            cursor: none;
            padding-top: 0;
            transition: background-color 0.3s ease;
        }

        #content-wrapper {
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            align-items: center;
            width: 100%;
            transition: width 0.5s ease;
        }

        .page-title {
            font-size: 45px;
            font-weight: 400;
            color: #FFFF00;
            margin-bottom: 20px;
            min-height: 0;
            position: relative;
            text-align: center;
            width: 90vw;
            max-width: 1000px;
        }

        .page-title.typing-cursor::after {
            content: '|';
            display: inline-block;
            animation: blink 1s infinite;
            color: #FFFF00;
            font-weight: 700;
            margin-left: 2px;
        }

        @keyframes blink {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0;
            }
        }

        .main-container {
            display: flex;
            justify-content: center;
            align-items: flex-start;
            gap: 30px;
            padding: 0px;
            transform: scale(0.666);
            transition: transform 0.5s ease;
        }

        .keyboard-container {
            display: flex;
            flex-direction: column;
            gap: 8px;
            padding: 20px;
            border: 1.5px solid #fff;
            border-radius: 10px;
            transition: border-color 0.3s ease;
        }

        .keyboard-row {
            display: flex;
            gap: 8px;
            justify-content: center;
            align-items: flex-end;
        }

        .key {
            width: 40px;
            height: 40px;
            border: 1.5px solid #fff;
            border-radius: 5px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 14px;
            font-weight: 500;
            box-sizing: border-box;
            transition: opacity 0.3s ease, background-color 0.1s, color 0.1s;
        }

        .key.active {
            background-color: #fff;
            color: #000;
            border-color: #fff;
        }

        .trackpad-container {
            width: 280px;
            height: 220px;
            border: 1.5px solid #fff;
            border-radius: 10px;
            margin-top: 0px;
            position: relative;
            overflow: hidden;
            transition: opacity 0.3s ease, border-color 0.3s ease;
        }

        .trackpad-cursor {
            width: 20px;
            height: 20px;
            background-color: #fff;
            border-radius: 50%;
            position: absolute;
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
            transition: opacity 1s ease, visibility 1s ease;
        }

        .trackpad-cursor.visible {
            opacity: 1;
            visibility: visible;
        }

        .arrow-key-cluster {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .arrow-key-row {
            display: flex;
            justify-content: center;
            gap: 8px;
        }

        .key.empty {
            border: none;
            visibility: hidden;
        }

        #left-arrow-key {
            transform: rotate(180deg);
        }

        /* Experience Mode Styles */
        body.experience-active {
            flex-direction: row;
            justify-content: center;
            align-items: center;
        }

        body.experience-active #content-wrapper {
            width: 50%;
            height: 100vh;
            flex-shrink: 0;
            justify-content: center;
        }

        body.experience-active .main-container {
            transform: scale(0.6);
        }

        body.experience-active .page-title {
            width: 90%;
            max-width: 500px;
            font-size: 30px;
            margin-bottom: -10px;
            min-height: 0px;
        }

        #experience-container {
            text-align: center;
            opacity: 0;
            transition: opacity 0.5s ease 0.2s;
            pointer-events: none;
            margin-top: -30px;
        }

        #experience-container.visible {
            opacity: 1;
            pointer-events: auto;
        }

        #experience-button {
            display: inline-block;
            border: 2px solid #FFFF00;
            color: #FFFF00;
            background: transparent;
            padding: 8px 18px;
            border-radius: 4px;
            font-size: 18px;
            font-weight: 500;
        }

        .space-hint {
            color: #FFFF00;
            font-size: 14px;
            margin-top: 4px;
            font-weight: 300;
        }



        #end-experience-container {
            text-align: center;
            opacity: 0;
            transition: opacity 0.5s ease;
            pointer-events: none;
            position: absolute;
            top: -30px;
            left: 0;
            width: 100%;
        }

        #end-experience-container.visible {
            opacity: 1;
            pointer-events: auto;
        }

        #end-experience-button {
            display: inline-block;
            border: 2px solid #FFFF00;
            color: #FFFF00;
            background: transparent;
            padding: 8px 18px;
            border-radius: 4px;
            font-size: 18px;
            font-weight: 500;
        }

        .button-wrapper {
            position: relative;
            width: 100%;
            display: flex;
            justify-content: center;
            margin-top: 0px;
            /* Reduced margin for closer spacing */
        }

        #book-container {
            display: none;
            width: 50%;
            height: 100vh;
            background-color: #111;
            color: #fff;
            justify-content: center;
            align-items: center;
            font-size: 24px;
            border-left: 1px solid #333;
            flex-shrink: 0;
            position: relative;
        }

        #scroll-hint {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            color: rgba(255, 255, 255, 0.5);
            font-size: 14px;
            font-family: "Noto Sans KR", sans-serif;
            pointer-events: none;
            z-index: 100;
            opacity: 0;
            transition: opacity 0.5s ease;
        }

        body.experience-active #scroll-hint {
            opacity: 1;
            transition-delay: 0.5s;
        }

        body.experience-active #book-container {
            display: flex;
        }

        /* 3D Book Styles */
        .book-wrapper {
            perspective: 1500px;
            display: flex;
            justify-content: center;
            align-items: center;
            width: 100%;
            height: 100%;
        }

        .book {
            width: 300px;
            height: 450px;
            position: relative;
            transform-style: preserve-3d;
            transform: rotateY(-30deg) rotateX(10deg);
            transition: transform 0.5s ease;
            box-shadow: 20px 20px 50px rgba(0, 0, 0, 0.5);
        }

        .book:hover {
            transform: rotateY(-25deg) rotateX(5deg) translateY(-10px);
        }

        .book-cover {
            position: absolute;
            width: 100%;
            height: 100%;
            transform-origin: left;
            z-index: 2;
            transform-style: preserve-3d;
        }

        .book-cover-face {
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            backface-visibility: hidden;
            border-radius: 5px 15px 15px 5px;
            border: 1px solid #333;
            overflow: hidden;
        }

        .book-cover-front {
            background: repeating-linear-gradient(90deg, #ff0000 0px, #ff0000 2px, #00ff00 2px, #00ff00 4px);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            box-shadow: inset 5px 0 10px rgba(0, 0, 0, 0.5);
            z-index: 2;
        }

        .book-cover-back {
            background: #fff;
            transform: rotateY(180deg);
            border-radius: 5px 0 0 5px;
            /* Rounded corners on the left when viewed from back */
            box-shadow: inset -5px 0 10px rgba(0, 0, 0, 0.1);
            z-index: 1;
        }

        .book-spine {
            position: absolute;
            top: 0;
            left: 0;
            width: 40px;
            height: 100%;
            background: linear-gradient(90deg, #111 0%, #222 40%, #111 100%);
            transform: rotateY(90deg) translateX(-20px) translateZ(-20px);
            /* Adjusted for thickness */
            transform-origin: left;
            border-radius: 5px 0 0 5px;
        }

        .book-pages {
            position: absolute;
            top: 5px;
            right: -35px;
            /* Width of pages */
            width: 40px;
            height: calc(100% - 10px);
            background: repeating-linear-gradient(90deg, #fff 0px, #eee 1px, #fff 2px);
            transform: rotateY(90deg) translateZ(-15px);
            /* Positioned relative to cover */
            transform-origin: left;
            box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.1);
        }

        /* Top and Bottom page edges for thickness illusion */
        .book-pages-top {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 40px;
            background: #f5f5f5;
            transform: rotateX(90deg) translateZ(-20px);
            /* Half of thickness */
            transform-origin: top;
            display: none;
            /* Simplified for now, can add if needed */
        }

        /* More detailed pages block to fill the volume */
        .page {
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            transform-style: preserve-3d;
            transform-origin: left;
            border-radius: 0 10px 10px 0;
        }

        .page-face {
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            backface-visibility: hidden;
            border-radius: 0 10px 10px 0;
            border: 1px solid #ccc;
        }

        .page-front {
            background: repeating-linear-gradient(90deg, #ff0000 0px, #ff0000 2px, #00ff00 2px, #00ff00 4px);
        }

        .page-back {
            background: #fff;
            transform: rotateY(180deg);
            border-radius: 10px 0 0 10px;
            /* Rounded corners on the left when viewed from back */
        }

        /* Base block behind pages */
        .book-body {
            position: absolute;
            top: 5px;
            left: 5px;
            width: calc(100% - 10px);
            height: calc(100% - 10px);
            background: #fff;
            transform: translateZ(-10px);
            border-radius: 0 10px 10px 0;
            box-shadow: inset -5px 0 10px rgba(0, 0, 0, 0.1);
        }

        .book-title-text {
            font-family: "Noto Sans KR", serif;
            /* Changed to serif for classic look */
            color: #000000;
            font-size: 36px;
            font-weight: 700;
            text-align: center;
            margin-bottom: 20px;
            text-shadow: none;
            border: 2px solid #000000;
            padding: 10px 20px;
            letter-spacing: 5px;
            position: relative;
            z-index: 10;
        }

        .book-author {
            font-family: "Noto Sans KR", serif;
            color: #000000;
            font-size: 14px;
            font-weight: 500;
            text-align: center;
            margin-top: -10px;
            letter-spacing: 2px;
            position: relative;
            z-index: 10;
            margin-bottom: 210px;
        }

        .book-decoration {
            width: 300px;
            height: 300px;
            position: absolute;
            bottom: -10px;
            left: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1;
        }

        .book-decoration img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            filter: drop-shadow(2px 2px 0px rgba(0, 0, 0, 0.1));
        }

        .global-nav {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 1000;
            color: rgba(255, 255, 255, 0.5);
            font-size: 14px;
            display: flex;
            gap: 15px;
            pointer-events: none;
            font-family: "Noto Sans KR", sans-serif;
        }

        .global-nav span.active {
            color: #FFFF00;
            opacity: 1;
        }

        .book-content {
            padding: 30px;
            width: 100%;
            height: 100%;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            align-items: center;
            color: #000;
            /* Text color on pattern */
        }

        .book-subtitle {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 20px;
            text-align: center;
            line-height: 1.4;
        }

        .book-text {
            font-size: 13px;
            line-height: 1.6;
            text-align: justify;
            font-weight: 500;
        }
    </style>
</head>

<body>

    <div class="global-nav">
        <span>[1] 시각장애인</span>
        <span>[2] 청각장애인</span>
        <span class="active">[3] 지체장애인 + 색각이상자</span>
    </div>

    <div id="content-wrapper">

        <h1 class="page-title" id="pageTitle"></h1>

        <div class="main-container">
            <div class="keyboard-container">

                <div class="keyboard-row">
                    <div class="key" data-code="Escape">ESC</div>
                    <div class="key" data-code="F1">F1</div>
                    <div class="key" data-code="F2">F2</div>
                    <div class="key" data-code="F3">F3</div>
                    <div class="key" data-code="F4">F4</div>
                    <div class="key" data-code="F5">F5</div>
                    <div class="key" data-code="F6">F6</div>
                    <div class="key" data-code="F7">F7</div>
                    <div class="key" data-code="F8">F8</div>
                    <div class="key" data-code="F9">F9</div>
                    <div class="key" data-code="F10">F10</div>
                    <div class="key" data-code="F11">F11</div>
                    <div class="key" data-code="F12">F12</div>
                    <div class="key" data-code="Power">⏻</div>
                </div>

                <div class="keyboard-row">
                    <div class="key" data-code="Backquote">` ~</div>
                    <div class="key" data-code="Digit1">1 !</div>
                    <div class="key" data-code="Digit2">2 @</div>
                    <div class="key" data-code="Digit3">3 #</div>
                    <div class="key" data-code="Digit4">4 $</div>
                    <div class="key" data-code="Digit5">5 %</div>
                    <div class="key" data-code="Digit6">6 ^</div>
                    <div class="key" data-code="Digit7">7 &</div>
                    <div class="key" data-code="Digit8">8 *</div>
                    <div class="key" data-code="Digit9">9 (</div>
                    <div class="key" data-code="Digit0">0 )</div>
                    <div class="key" data-code="Minus">- _</div>
                    <div class="key" data-code="Equal">= +</div>
                    <div class="key" data-code="Backspace" style="width: 88px;">DELETE</div>
                </div>

                <div class="keyboard-row">
                    <div class="key" data-code="Tab" style="width: 88px;">TAB</div>
                    <div class="key" data-code="KeyQ">Q</div>
                    <div class="key" data-code="KeyW">W</div>
                    <div class="key" data-code="KeyE">E</div>
                    <div class="key" data-code="KeyR">R</div>
                    <div class="key" data-code="KeyT">T</div>
                    <div class="key" data-code="KeyY">Y</div>
                    <div class="key" data-code="KeyU">U</div>
                    <div class="key" data-code="KeyI">I</div>
                    <div class="key" data-code="KeyO">O</div>
                    <div class="key" data-code="KeyP">P</div>
                    <div class="key" data-code="BracketLeft">[ {</div>
                    <div class="key" data-code="BracketRight">] }</div>
                    <div class="key" data-code="Backslash">\ |</div>
                </div>

                <div class="keyboard-row">
                    <div class="key" data-code="CapsLock" style="width: 108px;">CAPS</div>
                    <div class="key" data-code="KeyA">A</div>
                    <div class="key" data-code="KeyS">S</div>
                    <div class="key" data-code="KeyD">D</div>
                    <div class="key" data-code="KeyF">F</div>
                    <div class="key" data-code="KeyG">G</div>
                    <div class="key" data-code="KeyH">H</div>
                    <div class="key" data-code="KeyJ">J</div>
                    <div class="key" data-code="KeyK">K</div>
                    <div class="key" data-code="KeyL">L</div>
                    <div class="key" data-code="Semicolon">; :</div>
                    <div class="key" data-code="Quote">' "</div>
                    <div class="key" data-code="Enter" style="width: 88px;">ENTER</div>
                </div>

                <div class="keyboard-row">
                    <div class="key" data-code="ShiftLeft" style="width: 138px;">SHIFT</div>
                    <div class="key" data-code="KeyZ">Z</div>
                    <div class="key" data-code="KeyX">X</div>
                    <div class="key" data-code="KeyC">C</div>
                    <div class="key" data-code="KeyV">V</div>
                    <div class="key" data-code="KeyB">B</div>
                    <div class="key" data-code="KeyN">N</div>
                    <div class="key" data-code="KeyM">M</div>
                    <div class="key" data-code="Comma">, &lt;</div>
                    <div class="key" data-code="Period">. &gt;</div>
                    <div class="key" data-code="Slash">/ ?</div>
                    <div class="key" data-code="ShiftRight" style="width: 108px;">SHIFT</div>
                </div>

                <div class="keyboard-row">
                    <div class="key" data-code="Fn">fn</div>
                    <div class="key" data-code="ControlLeft">ctrl</div>
                    <div class="key" data-code="AltLeft">opt</div>
                    <div class="key" data-code="MetaLeft" style="width: 50px;">cmd</div>
                    <div class="key" data-code="Space" style="width: 236px;"></div>
                    <div class="key" data-code="MetaRight" style="width: 50px;">cmd</div>
                    <div class="key" data-code="AltRight">opt</div>
                    <div class="key" data-code="Lang1">한/영</div>

                    <div class="arrow-key-cluster">
                        <div class="arrow-key-row">
                            <div class="key empty" style="width: 40px;"></div>
                            <div class="key" data-code="ArrowUp">▲</div>
                            <div class="key empty" style="width: 40px;"></div>
                        </div>
                        <div class="arrow-key-row">
                            <div class="key" data-code="ArrowLeft" id="left-arrow-key">►</div>
                            <div class="key" data-code="ArrowDown">▼</div>
                            <div class="key" data-code="ArrowRight">►</div>
                        </div>
                    </div>
                </div>

            </div>

            <div class="trackpad-container" id="trackpad">
                <div class="trackpad-cursor" id="cursor"></div>
            </div>
        </div>

        <div class="button-wrapper">
            <div id="experience-container">
                <div id="experience-button">경험하기</div>
                <p class="space-hint">space</p>
            </div>

            <div id="end-experience-container">
                <div id="end-experience-button">체험 종료하기</div>
                <p class="space-hint">space</p>
            </div>
        </div>

    </div>

    <div id="book-container">
        <div class="book-wrapper">
            <div class="book">
                <div class="book-spine"></div>

                <!-- Base Body -->
                <div class="book-body"></div>

                <!-- Pages (Stack order: 5 at bottom, 1 at top) -->
                <div class="page" id="page5" style="z-index: 5;">
                    <div class="page-face page-front">
                        <div class="book-content">
                            <div class="book-subtitle">밤하늘의 별</div>
                            <div class="book-text">
                                "사람들은 저마다 별을 하나씩 가지고 있지만 모두 같은 별은 아니야. 여행하는 사람에게는 별이 길잡이가 되어 주고, 어떤 사람에게는 그저 조그만 빛일
                                뿐이지."<br><br>
                                "내가 저 별 중 하나에 살고 있을 테니까, 내가 저 별 중 하나에서 웃고 있을 테니까, 아저씨가 밤하늘을 바라볼 때면 모든 별들이 웃고 있는 것처럼 보일
                                거야. 아저씨는 웃을 줄 아는 별을 갖게 되는 거지."
                            </div>
                        </div>
                    </div>
                    <div class="page-face page-back"></div>
                </div>
                <div class="page" id="page4" style="z-index: 6;">
                    <div class="page-face page-front">
                        <div class="book-content">
                            <div class="book-subtitle">어른들은 누구나 처음엔 어린이였다</div>
                            <div class="book-text">
                                "어른들은 누구나 처음엔 어린이였다. 그러나 그것을 기억하는 어른은 별로 없다."<br><br>
                                "내가 좋아하는 사람이 나를 좋아해 주는 건 기적이야."<br><br>
                                "사막이 아름다운 건 어디엔가 우물을 감추고 있기 때문이야."<br><br>
                                "다른 사람에게는 결코 열어주지 않는 문을 당신에게만 열어주는 사람이 있다면 그 사람이야말로 당신의 진정한 친구이다."
                            </div>
                        </div>
                    </div>
                    <div class="page-face page-back"></div>
                </div>
                <div class="page" id="page3" style="z-index: 7;">
                    <div class="page-face page-front">
                        <div class="book-content">
                            <div class="book-subtitle">세상에서 가장 어려운 일</div>
                            <div class="book-text">
                                "세상에서 가장 어려운 일이 뭔지 아니?"<br><br>
                                "흠, 글쎄요. 돈 버는 일? 밥 먹는 일?"<br><br>
                                "세상에서 가장 어려운 일은 사람이 사람의 마음을 얻는 일이란다. 각각의 얼굴만큼 다양한 각양각색의 마음을... 순간에도 수만 가지의 생각이 떠오르는데 그
                                바람 같은 마음이 머물게 한다는 건 정말 어려운 거란다."
                            </div>
                        </div>
                    </div>
                    <div class="page-face page-back"></div>
                </div>
                <div class="page" id="page2" style="z-index: 8;">
                    <div class="page-face page-front">
                        <div class="book-content">
                            <div class="book-subtitle">너희는 나의 장미와 같지 않아</div>
                            <div class="book-text">
                                "너희들은 내 장미와 조금도 닮지 않았어. 너희들은 아직 아무것도 아니야." 어린 왕자가 그들에게 말했다.<br><br>
                                "(...) 물론 지나가는 사람들은 내 장미를 보고 너희들과 비슷하다고 생각할 거야. 하지만 그 꽃 한 송이가 내게는 너희들 전부보다 더 소중해. 내가 물을
                                준 꽃이니까. 내가 유리 고깔을 씌워 준 꽃이니까. 내가 벌레를 잡아 준 꽃이니까. 내가 불평을 들어주고, 자랑을 들어주고, 때로는 침묵까지 들어준 꽃이니까.
                                그게 내 장미니까."
                            </div>
                        </div>
                    </div>
                    <div class="page-face page-back"></div>
                </div>
                <div class="page" id="page1" style="z-index: 9;">
                    <div class="page-face page-front">
                        <div class="book-content">
                            <div class="book-subtitle">여우가 어린 왕자에게 남긴 마지막 선물</div>
                            <div class="book-text">
                                "잘 가." 여우가 말했다. "내 비밀은 이런 거야. 아주 간단해. 오로지 마음으로 보아야만 잘 보인다는 거야. 가장 중요한 건 눈에 보이지
                                않아."<br><br>
                                "가장 중요한 건 눈에 보이지 않아." 어린 왕자는 그 말을 기억해 두기 위해 되뇌었다.<br><br>
                                "네 장미꽃을 그토록 소중하게 만든 건 그 꽃을 위해 네가 공들인 그 시간 때문이야."<br><br>
                                "내 장미꽃을 그토록 소중하게 만든 건……." 어린 왕자는 잊어버리지 않기 위해 되뇌었다.
                            </div>
                        </div>
                    </div>
                    <div class="page-face page-back"></div>
                </div>

                <div class="book-cover" style="z-index: 10;">
                    <div class="book-cover-face book-cover-front">
                        <div class="book-title-text">어린왕자</div>
                        <div class="book-author">앙투안 드 생텍쥐페리</div>
                        <div class="book-decoration">
                            <img src="./prince.png" alt="Little Prince"
                                style="width: 100%; height: 100%; object-fit: contain;">
                        </div>
                    </div>
                    <div class="book-cover-face book-cover-back"></div>
                </div>
            </div>
            <div id="scroll-hint">스크롤을 내려 페이지를 넘겨주세요.</div>
        </div>
    </div>
    <script>
        document.addEventListener('DOMContentLoaded', () => {

            window.addEventListener('keydown', (e) => {
                playTypingSound();
                if (e.key === '1' || e.key === '2' || e.key === '3') {
                    if (bgm) {
                        bgm.pause();
                        sessionStorage.setItem('bgmTime', bgm.currentTime);
                        sessionStorage.setItem('bgmPlaying', 'true');
                    }
                }

                if (e.key === '1') window.location.href = 'index.html';
                if (e.key === '2') window.location.href = 'ear.html';
                if (e.key === '3') window.location.href = 'color.html';
            });

            // Resume background music if it was playing
            const bgmPlaying = sessionStorage.getItem('bgmPlaying');
            const bgmTime = sessionStorage.getItem('bgmTime');
            let bgm = null;

            if (bgmPlaying === 'true' && bgmTime) {
                bgm = new Audio('ravel.mp3');
                bgm.loop = true;
                bgm.currentTime = parseFloat(bgmTime);
                bgm.play().catch(e => console.log("Audio resume failed:", e));
                bgm.play().catch(e => console.log("Audio resume failed:", e));
            }

            // Typing sounds
            let currentKeySound = 1;
            const key1 = new Audio('key_1.wav');
            const key2 = new Audio('key_2.wav');

            function playTypingSound() {
                const soundToPlay = currentKeySound === 1 ? key1 : key2;
                soundToPlay.cloneNode().play().catch(e => console.log("Audio play failed:", e));
                currentKeySound = currentKeySound === 1 ? 2 : 1;
            }

            const initialText = "사서에게 빌린 책을 갖고 책상에 앉았습니다.<br>편하게 책을 읽어 보세요.";
            const secondText = "종이를 넘기며 책을 읽어 보세요.";

            const titleElement = document.getElementById('pageTitle');
            const experienceContainer = document.getElementById('experience-container');
            const endExperienceContainer = document.getElementById('end-experience-container');
            let isExperienceReady = false;
            let isExperienceActive = false;
            let isEndExperienceReady = false;

            const endExperienceButton = document.getElementById('end-experience-button');
            endExperienceButton.addEventListener('click', () => {
                if (bgm) {
                    bgm.pause();
                    sessionStorage.setItem('bgmTime', bgm.currentTime);
                    sessionStorage.setItem('bgmPlaying', 'true');
                }
                window.location.href = 'ending.html';
            });

            titleElement.classList.add('typing-cursor');

            let typeTimeout;
            function startTypewriter(text, onCompleteCallback) {
                clearTimeout(typeTimeout);
                titleElement.innerHTML = '';
                if (text) {
                    titleElement.classList.add('typing-cursor');
                }
                let index = 0;

                function typeChar() {
                    if (text && index < text.length) {
                        if (text.substring(index, index + 4) === '<br>') {
                            titleElement.innerHTML += '<br>';
                            index += 4;
                        } else {
                            titleElement.innerHTML += text.charAt(index);
                            index++;
                        }
                        typeTimeout = setTimeout(typeChar, 120);
                    } else {
                        titleElement.classList.remove('typing-cursor');
                        if (onCompleteCallback) {
                            onCompleteCallback();
                        }
                    }
                }
                typeChar();
            }

            // Start typing immediately
            startTypewriter(initialText, () => {
                experienceContainer.classList.add('visible');
                isExperienceReady = true;
            });

            // Keyboard interaction logic
            function animateKeyPress(keyCode) {
                const keyElement = document.querySelector(`.key[data-code="${keyCode}"]`);
                if (keyElement) {
                    keyElement.classList.add('active');
                    setTimeout(() => {
                        keyElement.classList.remove('active');
                    }, 200);
                }
            }

            window.addEventListener('keydown', (e) => {
                e.preventDefault();
                animateKeyPress(e.code);

                if (e.code === 'Space' && isExperienceReady && !isExperienceActive) {
                    isExperienceActive = true;
                    document.body.classList.add('experience-active');
                    experienceContainer.classList.remove('visible');
                    startTypewriter(secondText);
                }

                if (e.code === 'Space' && isEndExperienceReady) {
                    if (bgm) {
                        bgm.pause();
                        sessionStorage.setItem('bgmTime', bgm.currentTime);
                        sessionStorage.setItem('bgmPlaying', 'true');
                    }
                    window.location.href = 'ending.html';
                }
            });

            function resetExperience() {
                isExperienceActive = false;
                isEndExperienceReady = false;
                document.body.classList.remove('experience-active');
                endExperienceContainer.classList.remove('visible');

                // Reset scroll and book
                scrollProgress = 0;
                turnableItems.forEach(item => {
                    item.style.transform = '';
                });
                book.style.transform = '';

                // Reset to initial state
                startTypewriter(initialText, () => {
                    experienceContainer.classList.add('visible');
                    isExperienceReady = true;
                });
            }

            // Page turning logic
            let scrollProgress = 0;
            const scrollPerPage = 18000; // Resistance per page
            const bookCover = document.querySelector('.book-cover');
            const pages = Array.from(document.querySelectorAll('.page'));
            const book = document.querySelector('.book');

            // All turnable items: Cover first, then Page 1, 2, 3, 4, 5
            const turnableItems = [bookCover, ...pages.reverse()]; // Reverse to turn page 1 first, then 2, etc.
            const totalScroll = scrollPerPage * (turnableItems.length - 1);

            window.addEventListener('wheel', (e) => {
                if (!isExperienceActive) return;

                // Accumulate scroll
                scrollProgress += e.deltaY;

                // Clamp progress
                scrollProgress = Math.max(0, Math.min(totalScroll, scrollProgress));

                // Determine progress for each item
                turnableItems.forEach((item, index) => {
                    // Calculate start and end scroll points for this item
                    const startScroll = index * scrollPerPage;
                    const endScroll = (index + 1) * scrollPerPage;

                    let itemProgress = 0;
                    if (scrollProgress > startScroll) {
                        itemProgress = Math.min(scrollPerPage, scrollProgress - startScroll);
                    }

                    const progressRatio = itemProgress / scrollPerPage;

                    // Calculate rotation (0 to -130 degrees)
                    const rotation = progressRatio * -130;

                    item.style.transform = `rotateY(${rotation}deg)`;
                });

                // Global movement for the whole book
                // Move based ONLY on the cover's progress (first item)
                const coverProgress = Math.min(scrollPerPage, scrollProgress);
                const coverProgressRatio = coverProgress / scrollPerPage;
                const moveX = coverProgressRatio * 160;

                // Apply translation to book container
                book.style.transform = `translateX(${moveX}px) rotateY(-30deg) rotateX(10deg)`;

                // Check for end of book
                if (scrollProgress >= totalScroll - 100) { // Allow some buffer
                    endExperienceContainer.classList.add('visible');
                    isEndExperienceReady = true;
                } else {
                    endExperienceContainer.classList.remove('visible');
                    isEndExperienceReady = false;
                }
            });

            // Trackpad logic
            const trackpad = document.getElementById('trackpad');
            const cursor = document.getElementById('cursor');
            const cursorSize = 20;

            const trackpadWidth = trackpad.clientWidth;
            const trackpadHeight = trackpad.clientHeight;

            let cursorX = (trackpadWidth - cursorSize) / 2;
            let cursorY = (trackpadHeight - cursorSize) / 2;
            cursor.style.transform = `translate(${cursorX}px, ${cursorY}px)`;

            let lastMouseX = null;
            let lastMouseY = null;
            let movementTimer = null;

            document.addEventListener('mousemove', (e) => {
                if (lastMouseX === null) {
                    lastMouseX = e.clientX;
                    lastMouseY = e.clientY;
                    return;
                }

                if (movementTimer) {
                    clearTimeout(movementTimer);
                }

                cursor.classList.add('visible');

                const deltaX = e.clientX - lastMouseX;
                const deltaY = e.clientY - lastMouseY;

                cursorX += deltaX * 1.5;
                cursorY += deltaY * 1.5;

                cursorX = Math.max(0, Math.min(trackpadWidth - cursorSize, cursorX));
                cursorY = Math.max(0, Math.min(trackpadHeight - cursorSize, cursorY));

                cursor.style.transform = `translate(${cursorX}px, ${cursorY}px)`;

                lastMouseX = e.clientX;
                lastMouseY = e.clientY;

                movementTimer = setTimeout(() => {
                    cursor.classList.remove('visible');
                    lastMouseX = null;
                    lastMouseY = null;
                }, 1000);
            });
        });
    </script>
</body>

</html>